@using Dexterity.Components.Pages.Settings.Dialogs.Clinic.Components
@using Services.Features.Settings.Dtos
<MudDialog>
    <DialogContent>
        <Validations @ref="validations" Mode="ValidationMode.Manual" Model="ClinicDto">
            <MudStack Class="mt-2">
                <DexTextInputField Label="Name" @bind-FieldDataSource="@ClinicDto.Name"></DexTextInputField>
                <DexTextInputField Label="Address" @bind-FieldDataSource="@ClinicDto.Address"></DexTextInputField>
                <MudItem>
                    @if (Id > 0)
                    {
                        <ClinicSiteDataGrid ClinicId="Id" />
                    }
                </MudItem>
                <DexLoadingButton Name="Save" Click="SaveClinic" Processing="@_processing" Icon="fas fa-floppy-disk"></DexLoadingButton>
            </MudStack>
        </Validations>

    </DialogContent>
    <DialogActions>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance MudDialog { get; set; }
    [Parameter] public int Id { get; set; }
    private ClinicDto ClinicDto { get; set; } = new();
    private bool _processing;
    Validations validations;

    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {
            var s = await UnitOfWork.Setting.GetClinic(Id);
            ClinicDto = s.Data;
        }
    }

    private async Task SaveClinic()
    {
        _processing = true;
        if (await validations.ValidateAll())
        {
            var res = await UnitOfWork.Setting.SaveClinic(Id, ClinicDto);
            if (res.Succeeded)
            {
                Snackbar.SuccessMessge(res.Messages.First());
                MudDialog.Close();
            }
            else
            {
                Snackbar.FailMessge(res.Messages.First());
            }
        }

        await Task.Delay(1000);
        _processing = false;
    }

}